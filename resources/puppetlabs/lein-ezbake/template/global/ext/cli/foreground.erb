#!/usr/bin/env bash

if !(echo "${@}" | grep -e "--debug" -q)
then
    LOG_APPENDER="-Dlogappender=STDOUT"
fi

COMMAND="${JAVA_BIN} ${JAVA_ARGS} ${LOG_APPENDER} \
         -cp ${INSTALL_DIR}/<%= EZBake::Config[:uberjar_name] %> \
         clojure.main -m <%= EZBake::Config[:main_namespace] %> \
         --config ${CONFIG} --bootstrap-config ${BOOTSTRAP_CONFIG} \
         ${@}"

pushd "${INSTALL_DIR}" &> /dev/null

# USER is bound to the user puppetserver should run as in default or cli-app.
# USER in this context is not following Unix convention of being set to LOGNAME
if [ "$LOGNAME" = "$USER" ]; then
  $COMMAND
elif [ "$EUID" = "0" ]; then
  if command -v runuser &> /dev/null; then
    runuser "${USER}" -s /bin/bash -c "$COMMAND"
  elif command -v su &> /dev/null; then
    su "${USER}" -s /bin/bash -c "$COMMAND"
  else
    sudo -u "${USER}" $COMMAND
  fi
else
  echo "ERROR: Cannot start puppetserver from this shell, running as $LOGNAME" 1>&2
  echo "When running as $LOGNAME puppetserver cannot switch users to $USER" 1>&2
  echo "To proceed please try again from a shell running as root or $USER" 1>&2
  echo "" 1>&2
  echo "For example:" 1>&2
  echo "    sudo -H -u $USER /opt/puppetlabs/bin/puppetserver foreground" 1>&2

  exit 1
fi
popd &> /dev/null
