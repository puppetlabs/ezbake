#!/usr/bin/env bash

restartfile=/opt/puppetlabs/server/data/<%= EZBake::Config[:real_name] %>/restartcounter.txt
cur=$(head -n 1 $restartfile)
initial=$cur
timeout="300"

if [ -e $restartfile ];  then
    ${JAVA_BIN} ${JAVA_ARGS} -Djava.security.egd=/dev/urandom -cp ${INSTALL_DIR}/<%= EZBake::Config[:uberjar_name] %> clojure.main -m <%= EZBake::Config[:main_namespace] %> --config "${CONFIG}" -b "${BOOTSTRAP_CONFIG}" &
    while [ "$cur" == "$initial" ] ;do
        sleep 0.1
        cur=$(head -n 1 $restartfile)

        ((timeout--))
        if [ "$timeout" = 0 ]; then
            echo "Startup timed out"
            exit 1
        fi
    done
else
    echo "Restart file does not exist"
    exit 1
fi

exit 0
